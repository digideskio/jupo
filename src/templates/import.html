#! coding: utf-8
# pylint: disable-msg=W0311, E0611, E1101
# @PydevCodeAnalysisIgnore

import os
import re
import sys
import smaz
import fcntl
import struct
import socket
import base64
import hashlib
import logging
import calendar
import requests
import mimetypes

from os import urandom
from urllib import quote
from random import shuffle
from goose import Goose
from smtplib import SMTP
from unidecode import unidecode
from email.message import Message as EmailMsg
from email.header import Header
from email.MIMEText import MIMEText
from base64 import b64encode, b64decode
from lxml.html.diff import htmldiff
from itertools import izip
from uuid import uuid4, UUID
from string import capwords
from urllib2 import urlopen
from simplejson import dumps, loads
from time import mktime
from datetime import datetime, timedelta
from httplib import CannotSendRequest
from pyelasticsearch import ElasticSearch, ElasticHttpNotFoundError
from diff_match_patch import diff_match_patch
from flask_debugtoolbar_lineprofilerpanel.profile import line_profile

from lib import cache
from lib import encode_url
from lib.url import extract_urls
from lib.hot_ranking import get_score
from lib.pbkdf2 import pbkdf2_bin # From https://github.com/mitsuhiko/python-pbkdf2

from gridfs import GridFS, NoFile
from bson.binary import Binary
from bson.objectid import ObjectId
from gevent import spawn, joinall
from pymongo import MongoClient as MongoDB
from pymongo.son_manipulator import SON

from redis import Redis, ConnectionPool
from memcache import Client as Memcached
from jinja2 import Environment, FileSystemLoader

from boto.s3.key import Key
from boto.s3.connection import S3Connection
from rq import Queue, use_connection
from validate_email import validate_email
from apns import APNs, Payload

import dateutil.parser as dateparser
from facebook import GraphAPI
import urllib
from urlparse import urlparse
import inspect


from flask import request
from flask import session

try:
  from collections import OrderedDict as odict
except ImportError:
  from ordereddict import OrderedDict as odict


from models import (User, Group, Browser,
                    Comment, Feed, File, Note,
                    Version, Notification, Attachment, Reminder,
                    URL, Result, Event, Message, Topic)

import app
import filters
import settings

requests.adapters.DEFAULT_RETRIES = 3
months = dict((k,v) for k,v in enumerate(calendar.month_abbr)) 

# switch from the default ASCII to UTF-8 encoding
reload(sys)
sys.setdefaultencoding("utf-8")


DATABASE = MongoDB(settings.MONGOD_SERVERS, use_greenlets=True)
DATABASE['global'].user.ensure_index('email', background=True)
DATABASE['global'].spelling_suggestion.ensure_index('keyword', background=True)

INDEX = ElasticSearch('http://%s/' % settings.ELASTICSEARCH_SERVER)

host, port = settings.REDIS_SERVER.split(':')
FORGOT_PASSWORD = Redis(host=host, port=int(port), db=1)


if settings.AWS_KEY and settings.S3_BUCKET_NAME:
  s3_conn = S3Connection(settings.AWS_KEY, settings.AWS_SECRET, is_secure=False)
  BUCKET = s3_conn.get_bucket(settings.S3_BUCKET_NAME)
else:
  BUCKET = None

goose = Goose()
dmp = diff_match_patch()

host, port = settings.REDIS_PINGPONG_SERVER.split(':')
PINGPONG = Redis(host=host, port=int(port), db=0)

host, port = settings.REDIS_PUBSUB_SERVER.split(':')
pool = ConnectionPool(host=host, port=int(port), db=0)
PUBSUB = Redis(connection_pool=pool)

host, port = settings.REDIS_TASKQUEUE_SERVER.split(':')
TASKQUEUE = Redis(host=host, port=int(port), db=0)

use_connection(TASKQUEUE)
push_queue = Queue('push')
index_queue = Queue('index')
crawler_queue = Queue('urls')
invite_queue